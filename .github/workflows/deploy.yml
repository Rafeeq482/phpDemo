name: Deploy via Bastion

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up SSH Agent
      uses: webfactory/ssh-agent@v0.5.4
      with:
        ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

    - name: Add Bastion and App instance to known_hosts
      run: |
        mkdir -p ~/.ssh
        ssh-keyscan -H ${{ secrets.BASTION_PUBLIC_IP }} >> ~/.ssh/known_hosts
        ssh -o StrictHostKeyChecking=no \
            -o ProxyCommand="ssh -o StrictHostKeyChecking=no ubuntu@${{ secrets.BASTION_PUBLIC_IP }} -W %h:%p" \
            ubuntu@${{ secrets.APP_PRIVATE_IP }} "exit" || true

    - name: Pull latest code on app server via Bastion
      run: |
        ssh -o ProxyCommand="ssh -o StrictHostKeyChecking=no ubuntu@${{ secrets.BASTION_PUBLIC_IP }} -W %h:%p" \
            ubuntu@${{ secrets.APP_PRIVATE_IP }} << 'EOF'
          if [ -d /var/www/html/phpDemo/.git ]; then
            sudo git -C /var/www/html/phpDemo pull origin main
          else
            sudo git clone $REPO_URL /var/www/html/phpDemo
          fi
        EOF
